<script>
  const imageURLs = [
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423126/dxbaofixbvpcxfvhe9wl.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423153/cch4j8fbpkb16vy3xwlq.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423384/vhczxko3ghfm0iicgdmv.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423192/qxtvetem8vk9duqcz1f8.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423214/p7dkujce1xdtszarwy7i.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423232/tcihdskecj4hr5gvvhtb.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423252/dv3w1swwuyzhxiwgb7br.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423271/hpwrpqy9ecg1hzkdqapf.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423294/w7tvkbdbqujw0fhobdb3.jpg",
    "https://res.cloudinary.com/dtjjgiitl/image/upload/q_auto:good,f_auto,fl_progressive/v1753423314/lks1suqvhmrguybnufwa.jpg"
  ];

  const names = [
    "Pengutos #1 Frost Rookie",
    "Pengutos #2 Ice Hopper",
    "Pengutos #3 Snow Scout",
    "Pengutos #4 Chill Walker",
    "Pengutos #5 Ice Phantom",
    "Pengutos #6 Arctic Raider",
    "Pengutos #7 Frost Commander",
    "Pengutos #8 Snow King",
    "Pengutos #9 Ice God",
    "Pengutos #10 Emperor of Cold"
  ];

  const prices = [1, 1, 4, 4, 20, 20, 30, 35, 50, 1000];

  const container = document.getElementById("nftContainer");
  const connectBtn = document.getElementById("connectBtn");
  const walletAddrSpan = document.getElementById("walletAddress");

  let aptosWallet = null;
  let currentAddress = null;

  async function initWallet() {
    if (window.aptos && window.aptos.connect) {
      aptosWallet = window.aptos;
    } else {
      alert("Petra Wallet not found. Please install it first: https://petra.app");
    }
  }

  connectBtn.onclick = async () => {
    if (!aptosWallet) {
      alert("Petra Wallet not available");
      return;
    }

    try {
      if (!currentAddress) {
        const res = await aptosWallet.connect();
        currentAddress = res.address;
        walletAddrSpan.innerText = currentAddress.slice(0, 6) + "..." + currentAddress.slice(-4);
        connectBtn.innerText = "Disconnect Wallet";
      } else {
        await aptosWallet.disconnect();
        currentAddress = null;
        walletAddrSpan.innerText = "";
        connectBtn.innerText = "Connect Wallet";
      }
    } catch (e) {
      console.error(e);
      alert("Wallet connect failed. Check Petra and try again.");
    }
  };

  function renderAll() {
    container.innerHTML = "";
    for (let i = 0; i < 10; i++) {
      const card = document.createElement("div");
      card.className = "nft-card";
      card.innerHTML = `
        <img src="${imageURLs[i]}" alt="${names[i]}" />
        <h3>${names[i]}</h3>
        <p><b>${prices[i]} APT</b></p>
        <button class="btn" onclick="buyNFT(${prices[i]}, '${names[i]}')">Buy Now</button>
      `;
      container.appendChild(card);
    }
  }

  window.buyNFT = async (price, name) => {
    if (!currentAddress) {
      alert("Please connect wallet first");
      return;
    }

    try {
      // 1. Send payment
      const paymentPayload = {
        type: "entry_function_payload",
        function: "0x1::coin::transfer",
        type_arguments: ["0x1::aptos_coin::AptosCoin"],
        arguments: [
          "0x1f7c4a0e1b11abbe639cb52cd5fcc787cffc02f6da5ab3df0035139fce20a141",
          (price * 1e8).toString()
        ]
      };

      const paymentTx = await aptosWallet.signAndSubmitTransaction(paymentPayload);
      await waitForTxn(paymentTx.hash);

      alert(`âœ… Payment successful!\nTx Hash: ${paymentTx.hash}`);

      // 2. Trigger NFT Mint/Transfer (replace with your contract function)
      const nftPayload = {
        type: "entry_function_payload",
        function: "0xYourModule::pengutos_nft::mint_nft",
        type_arguments: [],
        arguments: [
          currentAddress,
          name
        ]
      };

      const nftTx = await aptosWallet.signAndSubmitTransaction(nftPayload);
      await waitForTxn(nftTx.hash);

      alert(`ðŸŽ‰ NFT "${name}" minted to your wallet!\nTx Hash: ${nftTx.hash}`);

    } catch (e) {
      console.error(e);
      alert("âŒ Something went wrong. Try again.");
    }
  };

  async function waitForTxn(hash) {
    let complete = false;
    while (!complete) {
      try {
        const res = await fetch(`https://fullnode.mainnet.aptoslabs.com/v1/transactions/by_hash/${hash}`);
        const json = await res.json();
        if (json.success) {
          complete = true;
        } else {
          await new Promise(r => setTimeout(r, 1500));
        }
      } catch {
        await new Promise(r => setTimeout(r, 1500));
      }
    }
  }

  function toggleTheme() {
    document.body.classList.toggle("light-mode");
  }

  initWallet();
  renderAll();
</script>
